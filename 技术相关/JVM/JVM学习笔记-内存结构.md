# 内存结构

## 整体架构

![image-20220324144053187](D:\学习笔记\技术相关\JVM\JVM学习笔记-内存结构.assets\image-20220324144053187.png)

## 1. 程序计数器

**作用**

- 用于保存 JVM 下一条要执行的指令的地址

**特点**

- 线程私有
  - 程序计数器是每个线程私有的，当另一个线程的时间片用完，又返回来执行当前线程的代码时，通过程序计数器就可以知道应该执行哪一条指令
- 不会存在内存溢出

## 2. 虚拟机栈

**定义**

- 每个**线程**运行需要的内存空间，成为**虚拟机栈**

- 每个栈由多个**栈帧**组成，对应着每次调用方法时所对应的内存
- 每个线程只能有一个**活动栈帧**，对应着**当前正在执行的方法**

**演示**

```java
public class Demo01 {
    public static void main(String[] args) {
        func1();
    }
    
    private static void func1() {
        func2();
    }
    
    private static void func2() {
        System.out.println(">>> func2");
    }
}
```

![image-20220324145851297](D:\学习笔记\技术相关\JVM\JVM学习笔记-内存结构.assets\image-20220324145851297.png)

**问题**

- 垃圾回收是否涉及栈内存？
  - 不涉及。因为虚拟机栈中是由一个个栈帧组成的，在方法执行完后，对应的栈帧就会弹出栈
- 栈内存分配越大越好？
  - 不是。因为物理内存是一定的，栈内存越大，虽然可以支持更多的方法调用，但可执行的线程数就会变少
- 方法内的局部变量是否是线程安全的？
  - 如果方法内的局部变量没有逃离方法的作用范围，则是线程安全的
  - 如果引用了对象，并逃离了方法的作用范围，则需要考虑线程安全问题

## 3. 本地方法栈

**定义**

- 带有 **native 关键字**的方法。因为 Java 不能直接与操作系统底层交互，所以需要使用 C/C++ 的方法进行交互

**示例**

![image-20220324151128200](D:\学习笔记\技术相关\JVM\JVM学习笔记-内存结构.assets\image-20220324151128200.png)

## 4. 堆

**定义**

- 通过 new 关键字创建的对象都会在堆内存中

**特点**

- 线程共享，**堆中的对象都需要考虑线程安全的问题**
- 有垃圾回收机制

## 5. 方法区

### 结构

![image-20220324151555518](D:\学习笔记\技术相关\JVM\JVM学习笔记-内存结构.assets\image-20220324151555518.png)

### 内存溢出

- JDK1.8 以前，会导致 **PermGen（永久代）**溢出
- JDK1.8 以后，会导致 **Metaspace（元空间）**溢出

### 常量池

- 二进制字节码的组成：类的基本信息、常量池、类的方法和定义（包含了虚拟机指令）

通过反编译来查看类的信息：

- 找到类对应的 ```.class``` 文件

- 通过 ```javap -v``` 命令即可查看

  ![image-20220324152259235](D:\学习笔记\技术相关\JVM\JVM学习笔记-内存结构.assets\image-20220324152259235.png)

### 运行时常量池

- 常量池：就是一张常量表（上图中红色框框的部分），虚拟机指令根据这张常量表找到要执行的类名、方法名、参数类型、字面量等信息
- 运行时常量池：常量池是 ```*.class``` 文件中的，当该类被加载时，它的常量池信息就会放入运行时常量池中，并且把里面的符号地址变为真实地址

### StringTable 及其特性

**特性**

- 常量池中的字符串仅是符号，在第一次使用时才会变为对象
- 利用串池机制，可以避免重复创建字符串对象
- jdk1.8 中，字符串变量的拼接原理是 StringBuilder
- 字符串常量拼接的原理是编译器优化
- 可以使用 intern() 方法，主动将串池中还不存在的字符串放入串池
  - jdk1.8，将这个字符串对象尝试放入串池中，如果串池中有则不放入，如果串池中没有则放入，返回串池中的对象

### StringTable 垃圾回收





### StringTable 性能调优

